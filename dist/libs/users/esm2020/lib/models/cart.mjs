import { Subject } from 'rxjs';
import { ProductLuca } from './productLuca';
import { Injectable } from '@angular/core';
import { ProductVariant } from './productVariant';
import * as i0 from "@angular/core";
export class Cart {
    constructor() {
        console.log("someone construcred me!");
        this.products = [];
        this.items = new Subject();
        setInterval(() => {
            // Make your auth call and export this from Service
            //console.log("updating total number = " + this.getTotalNumberOfItems());
            this.items.next(this.getTotalNumberOfItems());
        }, 7000);
    }
    addProductLuca(ProductLuca) {
        //qui check se il prodotto non c'è gia
        this.products.push(ProductLuca);
        localStorage.setItem("cartByLuca", JSON.stringify(this.products));
    }
    emptyCart() {
        this.products = [];
        this.updateLocalStorage();
    }
    getproducts() {
        return this.products;
    }
    getproductsSize() {
        return this.products.length;
    }
    getProduct(index) {
        //console.log("get product = " + this.products[index].getJson());
        return this.products[index];
    }
    getJson() {
        return JSON.stringify(this.products);
    }
    getProductById(id) {
        let product = null;
        this.products.forEach(element => {
            if (element.getId() === id) {
                product = element;
            }
        });
        return product;
    }
    getVariantById(id) {
        let productVariant = null;
        this.products.forEach(element => {
            for (let i = 0; i < element.getVariants().length; i++) {
                let variant = element.getVariants()[i];
                if (variant.getId() === id) {
                    productVariant = variant;
                }
            }
        });
        return productVariant;
    }
    getProductByVariantId(id) {
        let product = null;
        this.products.forEach(element => {
            for (let i = 0; i < element.getVariants().length; i++) {
                let variant = element.getVariants()[i];
                if (variant.getId() === id) {
                    product = element;
                }
            }
        });
        return product;
    }
    updateLocalStorage() {
        localStorage.setItem("cartByLuca", JSON.stringify(this.products));
    }
    static generateCartFromLocalStorage() {
        let cart = new Cart();
        let cartJso2 = localStorage.getItem("cartByLuca");
        console.log("cartJson = " + JSON.stringify(cartJso2));
        //  if(cartJso2 == "[]") return new Cart();
        let cartJson = JSON.parse(localStorage.getItem("cartByLuca"));
        for (let i = 0; i < cartJson.length; i++) {
            let productJson = cartJson[i];
            //console.log(productJson);
            let p = new ProductLuca();
            p.setId(productJson.id);
            p.setDiscount(productJson.discount);
            p.setPrice(productJson.price);
            //console.log("main img inside json = " + productJson.mainImage);
            p.mainImage = productJson.mainImage;
            p.setName(productJson.name);
            let imagesJson = productJson.images;
            for (let y = 0; y < imagesJson.length; y++) {
                p.addImage(imagesJson[y]);
            }
            let variantsJson = productJson.variants;
            for (let y = 0; y < variantsJson.length; y++) {
                let variantJson = variantsJson[y];
                let pVariant = new ProductVariant(variantJson.id, variantJson.size, variantJson.inventory, variantJson.selected, variantJson.barcode);
                //console.log("pVariant = " + pVariant.getJson());
                p.variants.push(pVariant);
            }
            cart.addProductLuca(p);
        }
        console.log("ho trovato questo carrello: " + JSON.stringify(cart));
        return cart;
    }
    containsProduct(product) {
        let contains = false;
        //console.log("product = " + this.getJson());
        this.products.forEach(element => {
            if (element.getId() === product.getId()) {
                contains = true;
                return;
            }
        });
        return contains;
    }
    getProductIndex(product) {
        if (this.containsProduct(product)) {
            for (let i = 0; i < this.products.length; i++) {
                if (this.products[i].getId() == product.getId()) {
                    return i;
                }
            }
        }
        else {
            return null;
        }
    }
    getAllVariants() {
        let productsVariants = [];
        this.products.forEach(p => {
            p.getVariants().forEach(variant => {
                productsVariants.push(variant);
            });
        });
        return productsVariants;
    }
    getItems() {
        return this.items;
    }
    getTotalNumberOfItems() {
        let total = 0;
        this.products.forEach(p => {
            p.getVariants().forEach(variant => {
                total += variant.getSelected();
            });
        });
        return total;
    }
    getTotalPrice() {
        let total = 0;
        this.products.forEach(p => {
            p.getVariants().forEach(variant => {
                total += variant.getSelected() * p.getPricec();
            });
        });
        return total;
    }
    deleteProductVariant(product) {
        let p = this.getProductByVariantId(product.getId());
        p.removeVariant(product);
    }
    getTotalNumberOfVariantsOfASingleProductByIdOfAVariant(id) {
        let productSize = null;
        this.products.forEach(element => {
            for (let i = 0; i < element.getVariants().length; i++) {
                let variant = element.getVariants()[i];
                if (variant.getId() === id) {
                    productSize = element.getVariants().length;
                }
            }
        });
        return productSize;
    }
}
Cart.ɵfac = function Cart_Factory(t) { return new (t || Cart)(); };
Cart.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: Cart, factory: Cart.ɵfac, providedIn: 'root' });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(Cart, [{
        type: Injectable,
        args: [{
                providedIn: 'root',
            }]
    }], function () { return []; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FydC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvdXNlcnMvc3JjL2xpYi9tb2RlbHMvY2FydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7O0FBTWxELE1BQU0sT0FBTyxJQUFJO0lBS2I7UUFDSSxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzNCLFdBQVcsQ0FBQyxHQUFHLEVBQUU7WUFDYixtREFBbUQ7WUFDbkQseUVBQXlFO1lBQ3pFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLENBQUM7UUFDaEQsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFBO0lBQ2QsQ0FBQztJQUVNLGNBQWMsQ0FBQyxXQUF3QjtRQUMxQyxzQ0FBc0M7UUFDdEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDaEMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUV0RSxDQUFDO0lBRU0sU0FBUztRQUNaLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFFTSxXQUFXO1FBQ2QsT0FB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LFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDdkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFFNUIsS0FBSSxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUM7Z0JBQy9DLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdkMsSUFBRyxPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFDO29CQUN0QixXQUFXLEdBQUcsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLE1BQU0sQ0FBQztpQkFDOUM7YUFDSjtRQUVMLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBUSxXQUFXLENBQUM7SUFDeEIsQ0FBQzs7d0RBaE9RLElBQUk7MERBQUosSUFBSSxXQUFKLElBQUksbUJBRkQsTUFBTTt1RkFFVCxJQUFJO2NBSGhCLFVBQVU7ZUFBQztnQkFDUixVQUFVLEVBQUUsTUFBTTthQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFByb2R1Y3RMdWNhIH0gZnJvbSAnLi9wcm9kdWN0THVjYSdcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFByb2R1Y3RWYXJpYW50IH0gZnJvbSAnLi9wcm9kdWN0VmFyaWFudCc7XG5cblxuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290JyxcbiAgfSlcbmV4cG9ydCBjbGFzcyBDYXJ0e1xuXG4gICAgcHJpdmF0ZSBwcm9kdWN0czogUHJvZHVjdEx1Y2FbXTtcbiAgICBwcml2YXRlIGl0ZW1zOiBTdWJqZWN0PG51bWJlcj47XG5cbiAgICBjb25zdHJ1Y3Rvcigpe1xuICAgICAgICBjb25zb2xlLmxvZyhcInNvbWVvbmUgY29uc3RydWNyZWQgbWUhXCIpO1xuICAgICAgICB0aGlzLnByb2R1Y3RzID0gW107XG4gICAgICAgIHRoaXMuaXRlbXMgPSBuZXcgU3ViamVjdCgpO1xuICAgICAgICBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICAvLyBNYWtlIHlvdXIgYXV0aCBjYWxsIGFuZCBleHBvcnQgdGhpcyBmcm9tIFNlcnZpY2VcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coXCJ1cGRhdGluZyB0b3RhbCBudW1iZXIgPSBcIiArIHRoaXMuZ2V0VG90YWxOdW1iZXJPZkl0ZW1zKCkpO1xuICAgICAgICAgICAgdGhpcy5pdGVtcy5uZXh0KHRoaXMuZ2V0VG90YWxOdW1iZXJPZkl0ZW1zKCkpO1xuICAgICAgICAgIH0sIDcwMDApXG4gICAgfVxuXG4gICAgcHVibGljIGFkZFByb2R1Y3RMdWNhKFByb2R1Y3RMdWNhOiBQcm9kdWN0THVjYSkgOnZvaWQge1xuICAgICAgICAvL3F1aSBjaGVjayBzZSBpbCBwcm9kb3R0byBub24gYyfDqCBnaWFcbiAgICAgICAgdGhpcy5wcm9kdWN0cy5wdXNoKFByb2R1Y3RMdWNhKTtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJjYXJ0QnlMdWNhXCIsIEpTT04uc3RyaW5naWZ5KHRoaXMucHJvZHVjdHMpKTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBlbXB0eUNhcnQoKXtcbiAgICAgICAgdGhpcy5wcm9kdWN0cyA9IFtdO1xuICAgICAgICB0aGlzLnVwZGF0ZUxvY2FsU3RvcmFnZSgpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRwcm9kdWN0cygpIDogUHJvZHVjdEx1Y2FbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb2R1Y3RzO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRwcm9kdWN0c1NpemUoKSA6IG51bWJlcntcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvZHVjdHMubGVuZ3RoO1xuICAgIH1cbiAgICBwdWJsaWMgZ2V0UHJvZHVjdChpbmRleDpudW1iZXIpIDogUHJvZHVjdEx1Y2Ege1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcImdldCBwcm9kdWN0ID0gXCIgKyB0aGlzLnByb2R1Y3RzW2luZGV4XS5nZXRKc29uKCkpO1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9kdWN0c1tpbmRleF07XG4gICAgfVxuXG4gICAgcHVibGljIGdldEpzb24oKSA6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLnByb2R1Y3RzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0UHJvZHVjdEJ5SWQoaWQ6c3RyaW5nKSA6IFByb2R1Y3RMdWNhIHtcbiAgICAgICAgbGV0IHByb2R1Y3QgPSBudWxsO1xuICAgICAgICB0aGlzLnByb2R1Y3RzLmZvckVhY2goZWxlbWVudCA9PiB7XG4gICAgICAgICAgICBpZihlbGVtZW50LmdldElkKCkgPT09IGlkKXtcbiAgICAgICAgICAgICAgICBwcm9kdWN0ID0gZWxlbWVudDtcblxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHByb2R1Y3Q7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFZhcmlhbnRCeUlkKGlkOnN0cmluZykgOiBQcm9kdWN0VmFyaWFudCB7XG4gICAgICAgIGxldCBwcm9kdWN0VmFyaWFudCA9IG51bGw7XG4gICAgICAgIHRoaXMucHJvZHVjdHMuZm9yRWFjaChlbGVtZW50ID0+IHtcblxuICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaTxlbGVtZW50LmdldFZhcmlhbnRzKCkubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgIGxldCB2YXJpYW50ID0gZWxlbWVudC5nZXRWYXJpYW50cygpW2ldO1xuICAgICAgICAgICAgICAgIGlmKHZhcmlhbnQuZ2V0SWQoKSA9PT0gaWQpe1xuICAgICAgICAgICAgICAgICAgICBwcm9kdWN0VmFyaWFudCA9IHZhcmlhbnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcHJvZHVjdFZhcmlhbnQ7XG4gICAgfVxuXG5cbiAgICBwdWJsaWMgZ2V0UHJvZHVjdEJ5VmFyaWFudElkKGlkOnN0cmluZykgOiBQcm9kdWN0THVjYSB7XG4gICAgICAgIGxldCBwcm9kdWN0ID0gbnVsbDtcbiAgICAgICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuXG4gICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpPGVsZW1lbnQuZ2V0VmFyaWFudHMoKS5sZW5ndGg7IGkrKyl7XG4gICAgICAgICAgICAgICAgbGV0IHZhcmlhbnQgPSBlbGVtZW50LmdldFZhcmlhbnRzKClbaV07XG4gICAgICAgICAgICAgICAgaWYodmFyaWFudC5nZXRJZCgpID09PSBpZCl7XG4gICAgICAgICAgICAgICAgICAgIHByb2R1Y3QgPSBlbGVtZW50O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHByb2R1Y3Q7XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZUxvY2FsU3RvcmFnZSgpOnZvaWR7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFwiY2FydEJ5THVjYVwiLCBKU09OLnN0cmluZ2lmeSh0aGlzLnByb2R1Y3RzKSk7XG4gICAgfVxuXG4gICAgIHN0YXRpYyBnZW5lcmF0ZUNhcnRGcm9tTG9jYWxTdG9yYWdlKCk6Q2FydHtcblxuICAgICAgICBsZXQgY2FydCA9IG5ldyBDYXJ0KCk7XG4gICAgICAgIGxldCBjYXJ0SnNvMiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFwiY2FydEJ5THVjYVwiKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJjYXJ0SnNvbiA9IFwiICsgSlNPTi5zdHJpbmdpZnkoY2FydEpzbzIpKTtcbiAgICAgIC8vICBpZihjYXJ0SnNvMiA9PSBcIltdXCIpIHJldHVybiBuZXcgQ2FydCgpO1xuICAgICAgXG4gICAgICAgICBsZXQgICBjYXJ0SnNvbiA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJjYXJ0QnlMdWNhXCIpKTtcbiAgICAgICAgZm9yKGxldCBpID0gMDsgaTxjYXJ0SnNvbi5sZW5ndGg7IGkrKyl7XG4gICAgICAgICAgICBsZXQgcHJvZHVjdEpzb24gPWNhcnRKc29uW2ldO1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhwcm9kdWN0SnNvbik7XG4gICAgICAgICAgICBsZXQgcCA9IG5ldyBQcm9kdWN0THVjYSgpO1xuICAgICAgICAgICAgcC5zZXRJZChwcm9kdWN0SnNvbi5pZCk7XG4gICAgICAgICAgICBwLnNldERpc2NvdW50KHByb2R1Y3RKc29uLmRpc2NvdW50KTtcbiAgICAgICAgICAgIHAuc2V0UHJpY2UocHJvZHVjdEpzb24ucHJpY2UpO1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcIm1haW4gaW1nIGluc2lkZSBqc29uID0gXCIgKyBwcm9kdWN0SnNvbi5tYWluSW1hZ2UpO1xuICAgICAgICAgICAgcC5tYWluSW1hZ2UgPSBwcm9kdWN0SnNvbi5tYWluSW1hZ2U7XG4gICAgICAgICAgICBwLnNldE5hbWUocHJvZHVjdEpzb24ubmFtZSk7XG5cbiAgICAgICAgICAgIGxldCBpbWFnZXNKc29uID0gcHJvZHVjdEpzb24uaW1hZ2VzO1xuICAgICAgICAgICAgZm9yKGxldCB5ID0gMDsgeTxpbWFnZXNKc29uLmxlbmd0aDsgeSsrKXtcbiAgICAgICAgICAgICAgICBwLmFkZEltYWdlKGltYWdlc0pzb25beV0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgdmFyaWFudHNKc29uID0gcHJvZHVjdEpzb24udmFyaWFudHM7XG4gICAgICAgICAgICBmb3IobGV0IHkgPSAwOyB5PHZhcmlhbnRzSnNvbi5sZW5ndGg7IHkrKyl7XG4gICAgICAgICAgICAgICAgbGV0IHZhcmlhbnRKc29uID0gdmFyaWFudHNKc29uW3ldO1xuICAgICAgICAgICAgICAgIGxldCBwVmFyaWFudCA9IG5ldyBQcm9kdWN0VmFyaWFudCh2YXJpYW50SnNvbi5pZCwgdmFyaWFudEpzb24uc2l6ZSwgdmFyaWFudEpzb24uaW52ZW50b3J5LCB2YXJpYW50SnNvbi5zZWxlY3RlZCwgdmFyaWFudEpzb24uYmFyY29kZSk7XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcInBWYXJpYW50ID0gXCIgKyBwVmFyaWFudC5nZXRKc29uKCkpO1xuICAgICAgICAgICAgICAgIHAudmFyaWFudHMucHVzaChwVmFyaWFudCk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY2FydC5hZGRQcm9kdWN0THVjYShwKTtcblxuXG4gICAgICAgIH1cblxuICAgICAgICBjb25zb2xlLmxvZyhcImhvIHRyb3ZhdG8gcXVlc3RvIGNhcnJlbGxvOiBcIiArIEpTT04uc3RyaW5naWZ5KGNhcnQpKTtcbiAgICAgICAgcmV0dXJuIGNhcnQ7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgY29udGFpbnNQcm9kdWN0KHByb2R1Y3Q6IFByb2R1Y3RMdWNhKTogYm9vbGVhbntcbiAgICAgICAgbGV0IGNvbnRhaW5zID0gZmFsc2U7XG4gICAgICAgIC8vY29uc29sZS5sb2coXCJwcm9kdWN0ID0gXCIgKyB0aGlzLmdldEpzb24oKSk7XG4gICAgICAgIHRoaXMucHJvZHVjdHMuZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgICAgICAgIGlmKGVsZW1lbnQuZ2V0SWQoKSA9PT0gcHJvZHVjdC5nZXRJZCgpKXtcbiAgICAgICAgICAgICAgICBjb250YWlucyA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gY29udGFpbnM7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFByb2R1Y3RJbmRleChwcm9kdWN0OiBQcm9kdWN0THVjYSk6IG51bWJlcntcbiAgICAgICBpZih0aGlzLmNvbnRhaW5zUHJvZHVjdChwcm9kdWN0KSl7XG4gICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpPHRoaXMucHJvZHVjdHMubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgIGlmKHRoaXMucHJvZHVjdHNbaV0uZ2V0SWQoKSA9PSBwcm9kdWN0LmdldElkKCkpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgfWVsc2V7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0QWxsVmFyaWFudHMoKTogUHJvZHVjdFZhcmlhbnRbXXtcblxuICAgICAgICBsZXQgcHJvZHVjdHNWYXJpYW50czpQcm9kdWN0VmFyaWFudFtdID0gW107XG5cbiAgICAgICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKHAgPT4ge1xuXG4gICAgICAgICAgICBwLmdldFZhcmlhbnRzKCkuZm9yRWFjaCh2YXJpYW50ID0+IHtcbiAgICAgICAgICAgICAgICBwcm9kdWN0c1ZhcmlhbnRzLnB1c2godmFyaWFudCk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcHJvZHVjdHNWYXJpYW50cztcbiAgICB9XG5cblxuICAgIHB1YmxpYyBnZXRJdGVtcygpOiBPYnNlcnZhYmxlPG51bWJlcj57XG4gICAgICAgIHJldHVybiB0aGlzLml0ZW1zO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRUb3RhbE51bWJlck9mSXRlbXMoKSA6IG51bWJlcntcbiAgICAgICAgbGV0IHRvdGFsOm51bWJlciA9IDA7XG4gICAgICAgIHRoaXMucHJvZHVjdHMuZm9yRWFjaChwID0+IHtcblxuICAgICAgICAgICAgcC5nZXRWYXJpYW50cygpLmZvckVhY2godmFyaWFudCA9PiB7XG4gICAgICAgICAgICAgICAgdG90YWwgKz0gdmFyaWFudC5nZXRTZWxlY3RlZCgpXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gdG90YWw7XG4gICAgfVxuXG5cbiAgICBwdWJsaWMgZ2V0VG90YWxQcmljZSgpIDogbnVtYmVye1xuICAgICAgICBsZXQgdG90YWw6bnVtYmVyID0gMDtcbiAgICAgICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKHAgPT4ge1xuXG4gICAgICAgICAgICBwLmdldFZhcmlhbnRzKCkuZm9yRWFjaCh2YXJpYW50ID0+IHtcbiAgICAgICAgICAgICAgICB0b3RhbCArPSB2YXJpYW50LmdldFNlbGVjdGVkKCkgKiBwLmdldFByaWNlYygpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHRvdGFsO1xuICAgIH1cblxuXG4gICAgcHVibGljIGRlbGV0ZVByb2R1Y3RWYXJpYW50KHByb2R1Y3Q6IFByb2R1Y3RWYXJpYW50KSA6IHZvaWR7XG4gICAgICAgIGxldCBwIDogUHJvZHVjdEx1Y2EgPSB0aGlzLmdldFByb2R1Y3RCeVZhcmlhbnRJZChwcm9kdWN0LmdldElkKCkpO1xuICAgICAgICBwLnJlbW92ZVZhcmlhbnQocHJvZHVjdCk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFRvdGFsTnVtYmVyT2ZWYXJpYW50c09mQVNpbmdsZVByb2R1Y3RCeUlkT2ZBVmFyaWFudChpZDpzdHJpbmcpIDogbnVtYmVyIHtcbiAgICAgICAgbGV0IHByb2R1Y3RTaXplID0gbnVsbDtcbiAgICAgICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuXG4gICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpPGVsZW1lbnQuZ2V0VmFyaWFudHMoKS5sZW5ndGg7IGkrKyl7XG4gICAgICAgICAgICAgICAgbGV0IHZhcmlhbnQgPSBlbGVtZW50LmdldFZhcmlhbnRzKClbaV07XG4gICAgICAgICAgICAgICAgaWYodmFyaWFudC5nZXRJZCgpID09PSBpZCl7XG4gICAgICAgICAgICAgICAgICAgIHByb2R1Y3RTaXplID0gZWxlbWVudC5nZXRWYXJpYW50cygpLmxlbmd0aDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiAgcHJvZHVjdFNpemU7XG4gICAgfVxufVxuIl19