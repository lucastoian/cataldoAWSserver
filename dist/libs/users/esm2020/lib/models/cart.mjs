import { Subject } from 'rxjs';
import { ProductLuca } from './productLuca';
import { Injectable } from '@angular/core';
import { ProductVariant } from './productVariant';
import * as i0 from "@angular/core";
export class Cart {
    constructor() {
        this.products = [];
        this.items = new Subject();
        setInterval(() => {
            // Make your auth call and export this from Service
            //console.log("updating total number = " + this.getTotalNumberOfItems());
            this.items.next(this.getTotalNumberOfItems());
        }, 2000);
    }
    ngOnInit() {
        console.log("basta chiamare carrello");
        Cart.getInstance();
    }
    static getInstance() {
        if (!Cart.sortedCart) {
            Cart.sortedCart = new Cart();
        }
        return Cart.sortedCart;
    }
    addProductLuca(ProductLuca) {
        //qui check se il prodotto non c'è gia
        this.products.push(ProductLuca);
        localStorage.setItem("cartByLuca", JSON.stringify(this.products));
    }
    emptyCart() {
        this.products = [];
        this.updateLocalStorage();
    }
    getproducts() {
        return this.products;
    }
    getproductsSize() {
        return this.products.length;
    }
    getProduct(index) {
        //console.log("get product = " + this.products[index].getJson());
        return this.products[index];
    }
    getJson() {
        return JSON.stringify(this.products);
    }
    getProductById(id) {
        let product = null;
        this.products.forEach(element => {
            if (element.getId() === id) {
                product = element;
            }
        });
        return product;
    }
    getVariantById(id) {
        let productVariant = null;
        this.products.forEach(element => {
            for (let i = 0; i < element.getVariants().length; i++) {
                let variant = element.getVariants()[i];
                if (variant.getId() === id) {
                    productVariant = variant;
                }
            }
        });
        return productVariant;
    }
    getProductByVariantId(id) {
        let product = null;
        this.products.forEach(element => {
            for (let i = 0; i < element.getVariants().length; i++) {
                let variant = element.getVariants()[i];
                if (variant.getId() === id) {
                    product = element;
                }
            }
        });
        return product;
    }
    updateLocalStorage() {
        localStorage.setItem("cartByLuca", JSON.stringify(this.products));
    }
    static generateCartFromLocalStorage() {
        Cart.sortedCart.products = [];
        //      Cart.getInstance();
        //   let cart = new Cart();
        let cartJso2 = localStorage.getItem("cartByLuca");
        console.log("cartJson = " + JSON.stringify(cartJso2));
        if (cartJso2 == null)
            return null;
        let cartJson = [];
        try {
            cartJson = JSON.parse(localStorage.getItem("cartByLuca"));
        }
        catch (e) {
            return null;
        }
        for (let i = 0; i < cartJson.length; i++) {
            let productJson = cartJson[i];
            //console.log(productJson);
            let p = new ProductLuca();
            p.setId(productJson.id);
            p.setDiscount(productJson.discount);
            p.setPrice(productJson.price);
            //console.log("main img inside json = " + productJson.mainImage);
            p.mainImage = productJson.mainImage;
            p.setName(productJson.name);
            let imagesJson = productJson.images;
            for (let y = 0; y < imagesJson.length; y++) {
                p.addImage(imagesJson[y]);
            }
            let variantsJson = productJson.variants;
            for (let y = 0; y < variantsJson.length; y++) {
                let variantJson = variantsJson[y];
                let pVariant = new ProductVariant(variantJson.id, variantJson.size, variantJson.inventory, variantJson.selected, variantJson.barcode);
                //console.log("pVariant = " + pVariant.getJson());
                p.variants.push(pVariant);
            }
            Cart.sortedCart.addProductLuca(p);
        }
        console.log("ho trovato questo carrello: " + JSON.stringify(Cart.sortedCart));
        return Cart.sortedCart;
    }
    containsProduct(product) {
        let contains = false;
        //console.log("product = " + this.getJson());
        this.products.forEach(element => {
            if (element.getId() === product.getId()) {
                contains = true;
                return;
            }
        });
        return contains;
    }
    getProductIndex(product) {
        if (this.containsProduct(product)) {
            for (let i = 0; i < this.products.length; i++) {
                if (this.products[i].getId() == product.getId()) {
                    return i;
                }
            }
        }
        else {
            return null;
        }
    }
    getAllVariants() {
        let productsVariants = [];
        this.products.forEach(p => {
            console.log("prodotto p: " + JSON.stringify(p));
            p.getVariants().forEach(variant => {
                variant.setMainProductImage(p.getMainImage());
                variant.setMainProductName(p.getName());
                productsVariants.push(variant);
            });
        });
        return productsVariants;
    }
    getItems() {
        return this.items;
    }
    getTotalNumberOfItems() {
        let total = 0;
        this.products.forEach(p => {
            p.getVariants().forEach(variant => {
                total += variant.getSelected();
            });
        });
        return total;
    }
    getTotalPrice() {
        let total = 0;
        this.products.forEach(p => {
            p.getVariants().forEach(variant => {
                total += variant.getSelected() * (p.getPricec() - p.getDiscount());
            });
        });
        return total;
    }
    deleteProductVariant(product) {
        let p = this.getProductByVariantId(product.getId());
        p.removeVariant(product);
    }
    getTotalNumberOfVariantsOfASingleProductByIdOfAVariant(id) {
        let productSize = null;
        this.products.forEach(element => {
            for (let i = 0; i < element.getVariants().length; i++) {
                let variant = element.getVariants()[i];
                if (variant.getId() === id) {
                    productSize = element.getVariants().length;
                }
            }
        });
        return productSize;
    }
}
Cart.ɵfac = function Cart_Factory(t) { return new (t || Cart)(); };
Cart.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: Cart, factory: Cart.ɵfac, providedIn: 'root' });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(Cart, [{
        type: Injectable,
        args: [{
                providedIn: 'root',
            }]
    }], function () { return []; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FydC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvdXNlcnMvc3JjL2xpYi9tb2RlbHMvY2FydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7O0FBTWxELE1BQU0sT0FBTyxJQUFJO0lBT2I7UUFFSSxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFDM0IsV0FBVyxDQUFDLEdBQUcsRUFBRTtZQUNiLG1EQUFtRDtZQUNuRCx5RUFBeUU7WUFDekUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixFQUFFLENBQUMsQ0FBQztRQUNoRCxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDZCxDQUFDO0lBRUQsUUFBUTtRQUNKLE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUV2QyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFPdkIsQ0FBQztJQUVNLE1BQU0sQ0FBQyxXQUFXO1FBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQ2xCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztTQUNoQztRQUVELE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUMzQixDQUFDO0lBRU0sY0FBYyxDQUFDLFdBQXdCO1FBQzFDLHNDQUFzQztRQUN0QyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNo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RyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUMsTUFBTSxDQUFDO2lCQUM5QzthQUNKO1FBRUwsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFRLFdBQVcsQ0FBQztJQUN4QixDQUFDOzt3REFyUVEsSUFBSTswREFBSixJQUFJLFdBQUosSUFBSSxtQkFGRCxNQUFNO3VGQUVULElBQUk7Y0FIaEIsVUFBVTtlQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgUHJvZHVjdEx1Y2EgfSBmcm9tICcuL3Byb2R1Y3RMdWNhJ1xuaW1wb3J0IHsgSW5qZWN0YWJsZSwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBQcm9kdWN0VmFyaWFudCB9IGZyb20gJy4vcHJvZHVjdFZhcmlhbnQnO1xuXG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCcsXG4gIH0pXG5leHBvcnQgY2xhc3MgQ2FydCBpbXBsZW1lbnRzIE9uSW5pdHtcblxuICAgIHByaXZhdGUgc3RhdGljIHNvcnRlZENhcnQ6IENhcnQ7XG5cbiAgICBwcml2YXRlIHByb2R1Y3RzOiBQcm9kdWN0THVjYVtdO1xuICAgIHByaXZhdGUgaXRlbXM6IFN1YmplY3Q8bnVtYmVyPjtcblxuICAgIGNvbnN0cnVjdG9yKCl7XG4gICAgICAgXG4gICAgICAgIHRoaXMucHJvZHVjdHMgPSBbXTtcbiAgICAgICAgdGhpcy5pdGVtcyA9IG5ldyBTdWJqZWN0KCk7XG4gICAgICAgIHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgICAgIC8vIE1ha2UgeW91ciBhdXRoIGNhbGwgYW5kIGV4cG9ydCB0aGlzIGZyb20gU2VydmljZVxuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcInVwZGF0aW5nIHRvdGFsIG51bWJlciA9IFwiICsgdGhpcy5nZXRUb3RhbE51bWJlck9mSXRlbXMoKSk7XG4gICAgICAgICAgICB0aGlzLml0ZW1zLm5leHQodGhpcy5nZXRUb3RhbE51bWJlck9mSXRlbXMoKSk7XG4gICAgICAgICAgfSwgMjAwMClcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpOiB2b2lke1xuICAgICAgICBjb25zb2xlLmxvZyhcImJhc3RhIGNoaWFtYXJlIGNhcnJlbGxvXCIpO1xuXG4gICAgICAgIENhcnQuZ2V0SW5zdGFuY2UoKTtcbiAgICAgXG4gICAgICAgIFxuXG5cbiAgICAgIFxuICAgIFxuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0SW5zdGFuY2UoKTogQ2FydHtcbiAgICAgICAgaWYgKCFDYXJ0LnNvcnRlZENhcnQpIHtcbiAgICAgICAgICAgIENhcnQuc29ydGVkQ2FydCA9IG5ldyBDYXJ0KCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gQ2FydC5zb3J0ZWRDYXJ0O1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRQcm9kdWN0THVjYShQcm9kdWN0THVjYTogUHJvZHVjdEx1Y2EpIDp2b2lkIHtcbiAgICAgICAgLy9xdWkgY2hlY2sgc2UgaWwgcHJvZG90dG8gbm9uIGMnw6ggZ2lhXG4gICAgICAgIHRoaXMucHJvZHVjdHMucHVzaChQcm9kdWN0THVjYSk7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFwiY2FydEJ5THVjYVwiLCBKU09OLnN0cmluZ2lmeSh0aGlzLnByb2R1Y3RzKSk7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgZW1wdHlDYXJ0KCl7XG4gICAgICAgIHRoaXMucHJvZHVjdHMgPSBbXTtcbiAgICAgICAgdGhpcy51cGRhdGVMb2NhbFN0b3JhZ2UoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0cHJvZHVjdHMoKSA6IFByb2R1Y3RMdWNhW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9kdWN0cztcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0cHJvZHVjdHNTaXplKCkgOiBudW1iZXJ7XG4gICAgICAgIHJldHVybiB0aGlzLnByb2R1Y3RzLmxlbmd0aDtcbiAgICB9XG4gICAgcHVibGljIGdldFByb2R1Y3QoaW5kZXg6bnVtYmVyKSA6IFByb2R1Y3RMdWNhIHtcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coXCJnZXQgcHJvZHVjdCA9IFwiICsgdGhpcy5wcm9kdWN0c1tpbmRleF0uZ2V0SnNvbigpKTtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvZHVjdHNbaW5kZXhdO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRKc29uKCkgOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodGhpcy5wcm9kdWN0cyk7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFByb2R1Y3RCeUlkKGlkOnN0cmluZykgOiBQcm9kdWN0THVjYSB7XG4gICAgICAgIGxldCBwcm9kdWN0ID0gbnVsbDtcbiAgICAgICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgICAgICAgaWYoZWxlbWVudC5nZXRJZCgpID09PSBpZCl7XG4gICAgICAgICAgICAgICAgcHJvZHVjdCA9IGVsZW1lbnQ7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBwcm9kdWN0O1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRWYXJpYW50QnlJZChpZDpzdHJpbmcpIDogUHJvZHVjdFZhcmlhbnQge1xuICAgICAgICBsZXQgcHJvZHVjdFZhcmlhbnQgPSBudWxsO1xuICAgICAgICB0aGlzLnByb2R1Y3RzLmZvckVhY2goZWxlbWVudCA9PiB7XG5cbiAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGk8ZWxlbWVudC5nZXRWYXJpYW50cygpLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgICAgICAgICBsZXQgdmFyaWFudCA9IGVsZW1lbnQuZ2V0VmFyaWFudHMoKVtpXTtcbiAgICAgICAgICAgICAgICBpZih2YXJpYW50LmdldElkKCkgPT09IGlkKXtcbiAgICAgICAgICAgICAgICAgICAgcHJvZHVjdFZhcmlhbnQgPSB2YXJpYW50O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHByb2R1Y3RWYXJpYW50O1xuICAgIH1cblxuXG4gICAgcHVibGljIGdldFByb2R1Y3RCeVZhcmlhbnRJZChpZDpzdHJpbmcpIDogUHJvZHVjdEx1Y2Ege1xuICAgICAgICBsZXQgcHJvZHVjdCA9IG51bGw7XG4gICAgICAgIHRoaXMucHJvZHVjdHMuZm9yRWFjaChlbGVtZW50ID0+IHtcblxuICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaTxlbGVtZW50LmdldFZhcmlhbnRzKCkubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgIGxldCB2YXJpYW50ID0gZWxlbWVudC5nZXRWYXJpYW50cygpW2ldO1xuICAgICAgICAgICAgICAgIGlmKHZhcmlhbnQuZ2V0SWQoKSA9PT0gaWQpe1xuICAgICAgICAgICAgICAgICAgICBwcm9kdWN0ID0gZWxlbWVudDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBwcm9kdWN0O1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVMb2NhbFN0b3JhZ2UoKTp2b2lke1xuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShcImNhcnRCeUx1Y2FcIiwgSlNPTi5zdHJpbmdpZnkodGhpcy5wcm9kdWN0cykpO1xuICAgIH1cblxuICAgICBzdGF0aWMgZ2VuZXJhdGVDYXJ0RnJvbUxvY2FsU3RvcmFnZSgpOkNhcnR7XG5cbiAgICAgICAgQ2FydC5zb3J0ZWRDYXJ0LnByb2R1Y3RzID0gW107XG5cbiAgLy8gICAgICBDYXJ0LmdldEluc3RhbmNlKCk7XG5cbiAgICAgLy8gICBsZXQgY2FydCA9IG5ldyBDYXJ0KCk7XG4gICAgICAgIGxldCBjYXJ0SnNvMiA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKFwiY2FydEJ5THVjYVwiKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJjYXJ0SnNvbiA9IFwiICsgSlNPTi5zdHJpbmdpZnkoY2FydEpzbzIpKTtcbiAgICAgICAgaWYoY2FydEpzbzIgPT0gbnVsbCkgcmV0dXJuIG51bGw7XG4gICAgICBcbiAgICAgICBsZXQgY2FydEpzb24gPSBbXTtcbiAgICAgICAgICAgIHRyeXtcbiAgICAgICAgICAgICBjYXJ0SnNvbiA9IEpTT04ucGFyc2UobG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJjYXJ0QnlMdWNhXCIpKTtcbiAgICAgICAgICAgIH1jYXRjaChlKXtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cblxuXG5cbiAgICAgICAgZm9yKGxldCBpID0gMDsgaTxjYXJ0SnNvbi5sZW5ndGg7IGkrKyl7XG4gICAgICAgICAgICBsZXQgcHJvZHVjdEpzb24gPWNhcnRKc29uW2ldO1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhwcm9kdWN0SnNvbik7XG4gICAgICAgICAgICBsZXQgcCA9IG5ldyBQcm9kdWN0THVjYSgpO1xuICAgICAgICAgICAgcC5zZXRJZChwcm9kdWN0SnNvbi5pZCk7XG4gICAgICAgICAgICBwLnNldERpc2NvdW50KHByb2R1Y3RKc29uLmRpc2NvdW50KTtcbiAgICAgICAgICAgIHAuc2V0UHJpY2UocHJvZHVjdEpzb24ucHJpY2UpO1xuICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcIm1haW4gaW1nIGluc2lkZSBqc29uID0gXCIgKyBwcm9kdWN0SnNvbi5tYWluSW1hZ2UpO1xuICAgICAgICAgICAgcC5tYWluSW1hZ2UgPSBwcm9kdWN0SnNvbi5tYWluSW1hZ2U7XG4gICAgICAgICAgICBwLnNldE5hbWUocHJvZHVjdEpzb24ubmFtZSk7XG5cbiAgICAgICAgICAgIGxldCBpbWFnZXNKc29uID0gcHJvZHVjdEpzb24uaW1hZ2VzO1xuICAgICAgICAgICAgZm9yKGxldCB5ID0gMDsgeTxpbWFnZXNKc29uLmxlbmd0aDsgeSsrKXtcbiAgICAgICAgICAgICAgICBwLmFkZEltYWdlKGltYWdlc0pzb25beV0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBsZXQgdmFyaWFudHNKc29uID0gcHJvZHVjdEpzb24udmFyaWFudHM7XG4gICAgICAgICAgICBmb3IobGV0IHkgPSAwOyB5PHZhcmlhbnRzSnNvbi5sZW5ndGg7IHkrKyl7XG4gICAgICAgICAgICAgICAgbGV0IHZhcmlhbnRKc29uID0gdmFyaWFudHNKc29uW3ldO1xuICAgICAgICAgICAgICAgIGxldCBwVmFyaWFudCA9IG5ldyBQcm9kdWN0VmFyaWFudCh2YXJpYW50SnNvbi5pZCwgdmFyaWFudEpzb24uc2l6ZSwgdmFyaWFudEpzb24uaW52ZW50b3J5LCB2YXJpYW50SnNvbi5zZWxlY3RlZCwgdmFyaWFudEpzb24uYmFyY29kZSk7XG4gICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyhcInBWYXJpYW50ID0gXCIgKyBwVmFyaWFudC5nZXRKc29uKCkpO1xuICAgICAgICAgICAgICAgIHAudmFyaWFudHMucHVzaChwVmFyaWFudCk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgQ2FydC5zb3J0ZWRDYXJ0LmFkZFByb2R1Y3RMdWNhKHApO1xuXG5cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnNvbGUubG9nKFwiaG8gdHJvdmF0byBxdWVzdG8gY2FycmVsbG86IFwiICsgSlNPTi5zdHJpbmdpZnkoQ2FydC5zb3J0ZWRDYXJ0KSk7XG4gICAgICAgIHJldHVybiBDYXJ0LnNvcnRlZENhcnQ7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgY29udGFpbnNQcm9kdWN0KHByb2R1Y3Q6IFByb2R1Y3RMdWNhKTogYm9vbGVhbntcbiAgICAgICAgbGV0IGNvbnRhaW5zID0gZmFsc2U7XG4gICAgICAgIC8vY29uc29sZS5sb2coXCJwcm9kdWN0ID0gXCIgKyB0aGlzLmdldEpzb24oKSk7XG4gICAgICAgIHRoaXMucHJvZHVjdHMuZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgICAgICAgIGlmKGVsZW1lbnQuZ2V0SWQoKSA9PT0gcHJvZHVjdC5nZXRJZCgpKXtcbiAgICAgICAgICAgICAgICBjb250YWlucyA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gY29udGFpbnM7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFByb2R1Y3RJbmRleChwcm9kdWN0OiBQcm9kdWN0THVjYSk6IG51bWJlcntcbiAgICAgICBpZih0aGlzLmNvbnRhaW5zUHJvZHVjdChwcm9kdWN0KSl7XG4gICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpPHRoaXMucHJvZHVjdHMubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgIGlmKHRoaXMucHJvZHVjdHNbaV0uZ2V0SWQoKSA9PSBwcm9kdWN0LmdldElkKCkpe1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgfWVsc2V7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0QWxsVmFyaWFudHMoKTogUHJvZHVjdFZhcmlhbnRbXXtcblxuICAgICAgICBsZXQgcHJvZHVjdHNWYXJpYW50czpQcm9kdWN0VmFyaWFudFtdID0gW107XG5cbiAgICAgICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKHAgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJwcm9kb3R0byBwOiBcIiArIEpTT04uc3RyaW5naWZ5KHApKVxuICAgICAgICAgICAgcC5nZXRWYXJpYW50cygpLmZvckVhY2godmFyaWFudCA9PiB7XG4gICAgICAgICAgICAgICAgdmFyaWFudC5zZXRNYWluUHJvZHVjdEltYWdlKHAuZ2V0TWFpbkltYWdlKCkpO1xuICAgICAgICAgICAgICAgIHZhcmlhbnQuc2V0TWFpblByb2R1Y3ROYW1lKHAuZ2V0TmFtZSgpKTtcbiAgICAgICAgIFxuICAgICAgICAgICAgICAgIHByb2R1Y3RzVmFyaWFudHMucHVzaCh2YXJpYW50KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBwcm9kdWN0c1ZhcmlhbnRzO1xuICAgIH1cblxuXG4gICAgcHVibGljIGdldEl0ZW1zKCk6IE9ic2VydmFibGU8bnVtYmVyPntcbiAgICAgICAgcmV0dXJuIHRoaXMuaXRlbXM7XG4gICAgfVxuXG4gICAgcHVibGljIGdldFRvdGFsTnVtYmVyT2ZJdGVtcygpIDogbnVtYmVye1xuICAgICAgICBsZXQgdG90YWw6bnVtYmVyID0gMDtcbiAgICAgICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKHAgPT4ge1xuXG4gICAgICAgICAgICBwLmdldFZhcmlhbnRzKCkuZm9yRWFjaCh2YXJpYW50ID0+IHtcbiAgICAgICAgICAgICAgICB0b3RhbCArPSB2YXJpYW50LmdldFNlbGVjdGVkKClcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0b3RhbDtcbiAgICB9XG5cblxuICAgIHB1YmxpYyBnZXRUb3RhbFByaWNlKCkgOiBudW1iZXJ7XG4gICAgICAgIGxldCB0b3RhbDpudW1iZXIgPSAwO1xuICAgICAgICB0aGlzLnByb2R1Y3RzLmZvckVhY2gocCA9PiB7XG5cbiAgICAgICAgICAgIHAuZ2V0VmFyaWFudHMoKS5mb3JFYWNoKHZhcmlhbnQgPT4ge1xuICAgICAgICAgICAgICAgIHRvdGFsICs9IHZhcmlhbnQuZ2V0U2VsZWN0ZWQoKSAqIChwLmdldFByaWNlYygpIC0gcC5nZXREaXNjb3VudCgpKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB0b3RhbDtcbiAgICB9XG5cblxuICAgIHB1YmxpYyBkZWxldGVQcm9kdWN0VmFyaWFudChwcm9kdWN0OiBQcm9kdWN0VmFyaWFudCkgOiB2b2lke1xuICAgICAgICBsZXQgcCA6IFByb2R1Y3RMdWNhID0gdGhpcy5nZXRQcm9kdWN0QnlWYXJpYW50SWQocHJvZHVjdC5nZXRJZCgpKTtcbiAgICAgICAgcC5yZW1vdmVWYXJpYW50KHByb2R1Y3QpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXRUb3RhbE51bWJlck9mVmFyaWFudHNPZkFTaW5nbGVQcm9kdWN0QnlJZE9mQVZhcmlhbnQoaWQ6c3RyaW5nKSA6IG51bWJlciB7XG4gICAgICAgIGxldCBwcm9kdWN0U2l6ZSA9IG51bGw7XG4gICAgICAgIHRoaXMucHJvZHVjdHMuZm9yRWFjaChlbGVtZW50ID0+IHtcblxuICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaTxlbGVtZW50LmdldFZhcmlhbnRzKCkubGVuZ3RoOyBpKyspe1xuICAgICAgICAgICAgICAgIGxldCB2YXJpYW50ID0gZWxlbWVudC5nZXRWYXJpYW50cygpW2ldO1xuICAgICAgICAgICAgICAgIGlmKHZhcmlhbnQuZ2V0SWQoKSA9PT0gaWQpe1xuICAgICAgICAgICAgICAgICAgICBwcm9kdWN0U2l6ZSA9IGVsZW1lbnQuZ2V0VmFyaWFudHMoKS5sZW5ndGg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gIHByb2R1Y3RTaXplO1xuICAgIH1cbn1cbiJdfQ==