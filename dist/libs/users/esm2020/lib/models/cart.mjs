import { Subject } from 'rxjs';
import { ProductLuca } from './productLuca';
import { Injectable } from '@angular/core';
import { ProductVariant } from './productVariant';
import * as i0 from "@angular/core";
export class Cart {
    constructor() {
        console.log("someone construcred me!");
        this.products = [];
        this.items = new Subject();
        setInterval(() => {
            // Make your auth call and export this from Service
            //console.log("updating total number = " + this.getTotalNumberOfItems());
            this.items.next(this.getTotalNumberOfItems());
        }, 7000);
    }
    addProductLuca(ProductLuca) {
        //qui check se il prodotto non c'è gia
        this.products.push(ProductLuca);
        localStorage.setItem("cartByLuca", JSON.stringify(this.products));
    }
    emptyCart() {
        this.products = [];
        this.updateLocalStorage();
    }
    getproducts() {
        return this.products;
    }
    getproductsSize() {
        return this.products.length;
    }
    getProduct(index) {
        //console.log("get product = " + this.products[index].getJson());
        return this.products[index];
    }
    getJson() {
        return JSON.stringify(this.products);
    }
    getProductById(id) {
        let product = null;
        this.products.forEach(element => {
            if (element.getId() === id) {
                product = element;
            }
        });
        return product;
    }
    getVariantById(id) {
        let productVariant = null;
        this.products.forEach(element => {
            for (let i = 0; i < element.getVariants().length; i++) {
                let variant = element.getVariants()[i];
                if (variant.getId() === id) {
                    productVariant = variant;
                }
            }
        });
        return productVariant;
    }
    getProductByVariantId(id) {
        let product = null;
        this.products.forEach(element => {
            for (let i = 0; i < element.getVariants().length; i++) {
                let variant = element.getVariants()[i];
                if (variant.getId() === id) {
                    product = element;
                }
            }
        });
        return product;
    }
    updateLocalStorage() {
        localStorage.setItem("cartByLuca", JSON.stringify(this.products));
    }
    static generateCartFromLocalStorage() {
        let cart = new Cart();
        let cartJso2 = localStorage.getItem("cartByLuca");
        console.log("cartJson = " + JSON.stringify(cartJso2));
        //  if(cartJso2 == "[]") return new Cart();
        let cartJson = JSON.parse(localStorage.getItem("cartByLuca"));
        for (let i = 0; i < cartJson.products.length; i++) {
            let productJson = cartJson.products[i];
            //console.log(productJson);
            let p = new ProductLuca();
            p.setId(productJson.id);
            p.setDiscount(productJson.discount);
            p.setPrice(productJson.price);
            //console.log("main img inside json = " + productJson.mainImage);
            p.mainImage = productJson.mainImage;
            p.setName(productJson.name);
            let imagesJson = productJson.images;
            for (let y = 0; y < imagesJson.length; y++) {
                p.addImage(imagesJson[y]);
            }
            let variantsJson = productJson.variants;
            for (let y = 0; y < variantsJson.length; y++) {
                let variantJson = variantsJson[y];
                let pVariant = new ProductVariant(variantJson.id, variantJson.size, variantJson.inventory, variantJson.selected, variantJson.barcode);
                //console.log("pVariant = " + pVariant.getJson());
                p.variants.push(pVariant);
            }
            cart.addProductLuca(p);
        }
        console.log("ho trovato questo carrello: " + JSON.stringify(cart));
        return cart;
    }
    containsProduct(product) {
        let contains = false;
        //console.log("product = " + this.getJson());
        this.products.forEach(element => {
            if (element.getId() === product.getId()) {
                contains = true;
                return;
            }
        });
        return contains;
    }
    getProductIndex(product) {
        if (this.containsProduct(product)) {
            for (let i = 0; i < this.products.length; i++) {
                if (this.products[i].getId() == product.getId()) {
                    return i;
                }
            }
        }
        else {
            return null;
        }
    }
    getAllVariants() {
        let productsVariants = [];
        this.products.forEach(p => {
            p.getVariants().forEach(variant => {
                productsVariants.push(variant);
            });
        });
        return productsVariants;
    }
    getItems() {
        return this.items;
    }
    getTotalNumberOfItems() {
        let total = 0;
        this.products.forEach(p => {
            p.getVariants().forEach(variant => {
                total += variant.getSelected();
            });
        });
        return total;
    }
    getTotalPrice() {
        let total = 0;
        this.products.forEach(p => {
            p.getVariants().forEach(variant => {
                total += variant.getSelected() * p.getPricec();
            });
        });
        return total;
    }
    deleteProductVariant(product) {
        let p = this.getProductByVariantId(product.getId());
        p.removeVariant(product);
    }
    getTotalNumberOfVariantsOfASingleProductByIdOfAVariant(id) {
        let productSize = null;
        this.products.forEach(element => {
            for (let i = 0; i < element.getVariants().length; i++) {
                let variant = element.getVariants()[i];
                if (variant.getId() === id) {
                    productSize = element.getVariants().length;
                }
            }
        });
        return productSize;
    }
}
Cart.ɵfac = function Cart_Factory(t) { return new (t || Cart)(); };
Cart.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: Cart, factory: Cart.ɵfac, providedIn: 'root' });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(Cart, [{
        type: Injectable,
        args: [{
                providedIn: 'root',
            }]
    }], function () { return []; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FydC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvdXNlcnMvc3JjL2xpYi9tb2RlbHMvY2FydC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7O0FBTWxELE1BQU0sT0FBTyxJQUFJO0lBS2I7UUFDSSxPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzNCLFdBQVcsQ0FBQyxHQUFHLEVBQUU7WUFDYixtREFBbUQ7WUFDbkQseUVBQXlFO1lBQ3pFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLENBQUM7UUFDaEQsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFBO0lBQ2QsQ0FBQztJQUVNLGNBQWMsQ0FBQyxXQUF3QjtRQUMxQyxzQ0FBc0M7UUFDdEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDaEMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUV0RSxDQUFDO0lBRU0sU0FBUztRQUNaLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFFTSxXQUFXO1FBQ2QsT0FB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Q0FBQyxFQUFTO1FBQ25FLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQztRQUN2QixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUU1QixLQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBQztnQkFDL0MsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN2QyxJQUFHLE9BQU8sQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUM7b0JBQ3RCLFdBQVcsR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUMsTUFBTSxDQUFDO2lCQUM5QzthQUNKO1FBRUwsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFRLFdBQVcsQ0FBQztJQUN4QixDQUFDOzt3REFoT1EsSUFBSTswREFBSixJQUFJLFdBQUosSUFBSSxtQkFGRCxNQUFNO3VGQUVULElBQUk7Y0FIaEIsVUFBVTtlQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBQcm9kdWN0THVjYSB9IGZyb20gJy4vcHJvZHVjdEx1Y2EnXHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUHJvZHVjdFZhcmlhbnQgfSBmcm9tICcuL3Byb2R1Y3RWYXJpYW50JztcclxuXHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCcsXHJcbiAgfSlcclxuZXhwb3J0IGNsYXNzIENhcnR7XHJcblxyXG4gICAgcHJpdmF0ZSBwcm9kdWN0czogUHJvZHVjdEx1Y2FbXTtcclxuICAgIHByaXZhdGUgaXRlbXM6IFN1YmplY3Q8bnVtYmVyPjtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcigpe1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwic29tZW9uZSBjb25zdHJ1Y3JlZCBtZSFcIik7XHJcbiAgICAgICAgdGhpcy5wcm9kdWN0cyA9IFtdO1xyXG4gICAgICAgIHRoaXMuaXRlbXMgPSBuZXcgU3ViamVjdCgpO1xyXG4gICAgICAgIHNldEludGVydmFsKCgpID0+IHtcclxuICAgICAgICAgICAgLy8gTWFrZSB5b3VyIGF1dGggY2FsbCBhbmQgZXhwb3J0IHRoaXMgZnJvbSBTZXJ2aWNlXHJcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2coXCJ1cGRhdGluZyB0b3RhbCBudW1iZXIgPSBcIiArIHRoaXMuZ2V0VG90YWxOdW1iZXJPZkl0ZW1zKCkpO1xyXG4gICAgICAgICAgICB0aGlzLml0ZW1zLm5leHQodGhpcy5nZXRUb3RhbE51bWJlck9mSXRlbXMoKSk7XHJcbiAgICAgICAgICB9LCA3MDAwKVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhZGRQcm9kdWN0THVjYShQcm9kdWN0THVjYTogUHJvZHVjdEx1Y2EpIDp2b2lkIHtcclxuICAgICAgICAvL3F1aSBjaGVjayBzZSBpbCBwcm9kb3R0byBub24gYyfDqCBnaWFcclxuICAgICAgICB0aGlzLnByb2R1Y3RzLnB1c2goUHJvZHVjdEx1Y2EpO1xyXG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFwiY2FydEJ5THVjYVwiLCBKU09OLnN0cmluZ2lmeSh0aGlzLnByb2R1Y3RzKSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBlbXB0eUNhcnQoKXtcclxuICAgICAgICB0aGlzLnByb2R1Y3RzID0gW107XHJcbiAgICAgICAgdGhpcy51cGRhdGVMb2NhbFN0b3JhZ2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0cHJvZHVjdHMoKSA6IFByb2R1Y3RMdWNhW10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnByb2R1Y3RzO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRwcm9kdWN0c1NpemUoKSA6IG51bWJlcntcclxuICAgICAgICByZXR1cm4gdGhpcy5wcm9kdWN0cy5sZW5ndGg7XHJcbiAgICB9XHJcbiAgICBwdWJsaWMgZ2V0UHJvZHVjdChpbmRleDpudW1iZXIpIDogUHJvZHVjdEx1Y2Ege1xyXG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiZ2V0IHByb2R1Y3QgPSBcIiArIHRoaXMucHJvZHVjdHNbaW5kZXhdLmdldEpzb24oKSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvZHVjdHNbaW5kZXhdO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRKc29uKCkgOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLnByb2R1Y3RzKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0UHJvZHVjdEJ5SWQoaWQ6c3RyaW5nKSA6IFByb2R1Y3RMdWNhIHtcclxuICAgICAgICBsZXQgcHJvZHVjdCA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xyXG4gICAgICAgICAgICBpZihlbGVtZW50LmdldElkKCkgPT09IGlkKXtcclxuICAgICAgICAgICAgICAgIHByb2R1Y3QgPSBlbGVtZW50O1xyXG5cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBwcm9kdWN0O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRWYXJpYW50QnlJZChpZDpzdHJpbmcpIDogUHJvZHVjdFZhcmlhbnQge1xyXG4gICAgICAgIGxldCBwcm9kdWN0VmFyaWFudCA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xyXG5cclxuICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaTxlbGVtZW50LmdldFZhcmlhbnRzKCkubGVuZ3RoOyBpKyspe1xyXG4gICAgICAgICAgICAgICAgbGV0IHZhcmlhbnQgPSBlbGVtZW50LmdldFZhcmlhbnRzKClbaV07XHJcbiAgICAgICAgICAgICAgICBpZih2YXJpYW50LmdldElkKCkgPT09IGlkKXtcclxuICAgICAgICAgICAgICAgICAgICBwcm9kdWN0VmFyaWFudCA9IHZhcmlhbnQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHByb2R1Y3RWYXJpYW50O1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwdWJsaWMgZ2V0UHJvZHVjdEJ5VmFyaWFudElkKGlkOnN0cmluZykgOiBQcm9kdWN0THVjYSB7XHJcbiAgICAgICAgbGV0IHByb2R1Y3QgPSBudWxsO1xyXG4gICAgICAgIHRoaXMucHJvZHVjdHMuZm9yRWFjaChlbGVtZW50ID0+IHtcclxuXHJcbiAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGk8ZWxlbWVudC5nZXRWYXJpYW50cygpLmxlbmd0aDsgaSsrKXtcclxuICAgICAgICAgICAgICAgIGxldCB2YXJpYW50ID0gZWxlbWVudC5nZXRWYXJpYW50cygpW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYodmFyaWFudC5nZXRJZCgpID09PSBpZCl7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJvZHVjdCA9IGVsZW1lbnQ7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHByb2R1Y3Q7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHVwZGF0ZUxvY2FsU3RvcmFnZSgpOnZvaWR7XHJcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJjYXJ0QnlMdWNhXCIsIEpTT04uc3RyaW5naWZ5KHRoaXMucHJvZHVjdHMpKTtcclxuICAgIH1cclxuXHJcbiAgICAgc3RhdGljIGdlbmVyYXRlQ2FydEZyb21Mb2NhbFN0b3JhZ2UoKTpDYXJ0e1xyXG5cclxuICAgICAgICBsZXQgY2FydCA9IG5ldyBDYXJ0KCk7XHJcbiAgICAgICAgbGV0IGNhcnRKc28yID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJjYXJ0QnlMdWNhXCIpO1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiY2FydEpzb24gPSBcIiArIEpTT04uc3RyaW5naWZ5KGNhcnRKc28yKSk7XHJcbiAgICAgIC8vICBpZihjYXJ0SnNvMiA9PSBcIltdXCIpIHJldHVybiBuZXcgQ2FydCgpO1xyXG4gICAgICBcclxuICAgICAgICAgbGV0ICAgY2FydEpzb24gPSBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKFwiY2FydEJ5THVjYVwiKSk7XHJcbiAgICAgICAgZm9yKGxldCBpID0gMDsgaTxjYXJ0SnNvbi5wcm9kdWN0cy5sZW5ndGg7IGkrKyl7XHJcbiAgICAgICAgICAgIGxldCBwcm9kdWN0SnNvbiA9Y2FydEpzb24ucHJvZHVjdHNbaV07XHJcbiAgICAgICAgICAgIC8vY29uc29sZS5sb2cocHJvZHVjdEpzb24pO1xyXG4gICAgICAgICAgICBsZXQgcCA9IG5ldyBQcm9kdWN0THVjYSgpO1xyXG4gICAgICAgICAgICBwLnNldElkKHByb2R1Y3RKc29uLmlkKTtcclxuICAgICAgICAgICAgcC5zZXREaXNjb3VudChwcm9kdWN0SnNvbi5kaXNjb3VudCk7XHJcbiAgICAgICAgICAgIHAuc2V0UHJpY2UocHJvZHVjdEpzb24ucHJpY2UpO1xyXG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwibWFpbiBpbWcgaW5zaWRlIGpzb24gPSBcIiArIHByb2R1Y3RKc29uLm1haW5JbWFnZSk7XHJcbiAgICAgICAgICAgIHAubWFpbkltYWdlID0gcHJvZHVjdEpzb24ubWFpbkltYWdlO1xyXG4gICAgICAgICAgICBwLnNldE5hbWUocHJvZHVjdEpzb24ubmFtZSk7XHJcblxyXG4gICAgICAgICAgICBsZXQgaW1hZ2VzSnNvbiA9IHByb2R1Y3RKc29uLmltYWdlcztcclxuICAgICAgICAgICAgZm9yKGxldCB5ID0gMDsgeTxpbWFnZXNKc29uLmxlbmd0aDsgeSsrKXtcclxuICAgICAgICAgICAgICAgIHAuYWRkSW1hZ2UoaW1hZ2VzSnNvblt5XSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCB2YXJpYW50c0pzb24gPSBwcm9kdWN0SnNvbi52YXJpYW50cztcclxuICAgICAgICAgICAgZm9yKGxldCB5ID0gMDsgeTx2YXJpYW50c0pzb24ubGVuZ3RoOyB5Kyspe1xyXG4gICAgICAgICAgICAgICAgbGV0IHZhcmlhbnRKc29uID0gdmFyaWFudHNKc29uW3ldO1xyXG4gICAgICAgICAgICAgICAgbGV0IHBWYXJpYW50ID0gbmV3IFByb2R1Y3RWYXJpYW50KHZhcmlhbnRKc29uLmlkLCB2YXJpYW50SnNvbi5zaXplLCB2YXJpYW50SnNvbi5pbnZlbnRvcnksIHZhcmlhbnRKc29uLnNlbGVjdGVkLCB2YXJpYW50SnNvbi5iYXJjb2RlKTtcclxuICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coXCJwVmFyaWFudCA9IFwiICsgcFZhcmlhbnQuZ2V0SnNvbigpKTtcclxuICAgICAgICAgICAgICAgIHAudmFyaWFudHMucHVzaChwVmFyaWFudCk7XHJcblxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjYXJ0LmFkZFByb2R1Y3RMdWNhKHApO1xyXG5cclxuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zb2xlLmxvZyhcImhvIHRyb3ZhdG8gcXVlc3RvIGNhcnJlbGxvOiBcIiArIEpTT04uc3RyaW5naWZ5KGNhcnQpKTtcclxuICAgICAgICByZXR1cm4gY2FydDtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNvbnRhaW5zUHJvZHVjdChwcm9kdWN0OiBQcm9kdWN0THVjYSk6IGJvb2xlYW57XHJcbiAgICAgICAgbGV0IGNvbnRhaW5zID0gZmFsc2U7XHJcbiAgICAgICAgLy9jb25zb2xlLmxvZyhcInByb2R1Y3QgPSBcIiArIHRoaXMuZ2V0SnNvbigpKTtcclxuICAgICAgICB0aGlzLnByb2R1Y3RzLmZvckVhY2goZWxlbWVudCA9PiB7XHJcbiAgICAgICAgICAgIGlmKGVsZW1lbnQuZ2V0SWQoKSA9PT0gcHJvZHVjdC5nZXRJZCgpKXtcclxuICAgICAgICAgICAgICAgIGNvbnRhaW5zID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gY29udGFpbnM7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldFByb2R1Y3RJbmRleChwcm9kdWN0OiBQcm9kdWN0THVjYSk6IG51bWJlcntcclxuICAgICAgIGlmKHRoaXMuY29udGFpbnNQcm9kdWN0KHByb2R1Y3QpKXtcclxuICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaTx0aGlzLnByb2R1Y3RzLmxlbmd0aDsgaSsrKXtcclxuICAgICAgICAgICAgICAgIGlmKHRoaXMucHJvZHVjdHNbaV0uZ2V0SWQoKSA9PSBwcm9kdWN0LmdldElkKCkpe1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICB9ZWxzZXtcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0QWxsVmFyaWFudHMoKTogUHJvZHVjdFZhcmlhbnRbXXtcclxuXHJcbiAgICAgICAgbGV0IHByb2R1Y3RzVmFyaWFudHM6UHJvZHVjdFZhcmlhbnRbXSA9IFtdO1xyXG5cclxuICAgICAgICB0aGlzLnByb2R1Y3RzLmZvckVhY2gocCA9PiB7XHJcblxyXG4gICAgICAgICAgICBwLmdldFZhcmlhbnRzKCkuZm9yRWFjaCh2YXJpYW50ID0+IHtcclxuICAgICAgICAgICAgICAgIHByb2R1Y3RzVmFyaWFudHMucHVzaCh2YXJpYW50KTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gcHJvZHVjdHNWYXJpYW50cztcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHVibGljIGdldEl0ZW1zKCk6IE9ic2VydmFibGU8bnVtYmVyPntcclxuICAgICAgICByZXR1cm4gdGhpcy5pdGVtcztcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0VG90YWxOdW1iZXJPZkl0ZW1zKCkgOiBudW1iZXJ7XHJcbiAgICAgICAgbGV0IHRvdGFsOm51bWJlciA9IDA7XHJcbiAgICAgICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKHAgPT4ge1xyXG5cclxuICAgICAgICAgICAgcC5nZXRWYXJpYW50cygpLmZvckVhY2godmFyaWFudCA9PiB7XHJcbiAgICAgICAgICAgICAgICB0b3RhbCArPSB2YXJpYW50LmdldFNlbGVjdGVkKClcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gdG90YWw7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHB1YmxpYyBnZXRUb3RhbFByaWNlKCkgOiBudW1iZXJ7XHJcbiAgICAgICAgbGV0IHRvdGFsOm51bWJlciA9IDA7XHJcbiAgICAgICAgdGhpcy5wcm9kdWN0cy5mb3JFYWNoKHAgPT4ge1xyXG5cclxuICAgICAgICAgICAgcC5nZXRWYXJpYW50cygpLmZvckVhY2godmFyaWFudCA9PiB7XHJcbiAgICAgICAgICAgICAgICB0b3RhbCArPSB2YXJpYW50LmdldFNlbGVjdGVkKCkgKiBwLmdldFByaWNlYygpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiB0b3RhbDtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHVibGljIGRlbGV0ZVByb2R1Y3RWYXJpYW50KHByb2R1Y3Q6IFByb2R1Y3RWYXJpYW50KSA6IHZvaWR7XHJcbiAgICAgICAgbGV0IHAgOiBQcm9kdWN0THVjYSA9IHRoaXMuZ2V0UHJvZHVjdEJ5VmFyaWFudElkKHByb2R1Y3QuZ2V0SWQoKSk7XHJcbiAgICAgICAgcC5yZW1vdmVWYXJpYW50KHByb2R1Y3QpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRUb3RhbE51bWJlck9mVmFyaWFudHNPZkFTaW5nbGVQcm9kdWN0QnlJZE9mQVZhcmlhbnQoaWQ6c3RyaW5nKSA6IG51bWJlciB7XHJcbiAgICAgICAgbGV0IHByb2R1Y3RTaXplID0gbnVsbDtcclxuICAgICAgICB0aGlzLnByb2R1Y3RzLmZvckVhY2goZWxlbWVudCA9PiB7XHJcblxyXG4gICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpPGVsZW1lbnQuZ2V0VmFyaWFudHMoKS5sZW5ndGg7IGkrKyl7XHJcbiAgICAgICAgICAgICAgICBsZXQgdmFyaWFudCA9IGVsZW1lbnQuZ2V0VmFyaWFudHMoKVtpXTtcclxuICAgICAgICAgICAgICAgIGlmKHZhcmlhbnQuZ2V0SWQoKSA9PT0gaWQpe1xyXG4gICAgICAgICAgICAgICAgICAgIHByb2R1Y3RTaXplID0gZWxlbWVudC5nZXRWYXJpYW50cygpLmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gIHByb2R1Y3RTaXplO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==